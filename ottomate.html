<!DOCTYPE HTML>
<html lang="en">
<head>
<title>OttoMate: G-code Generator for Otto</title>
<meta charset="utf-8">
<meta name="author" content="Keng Wooi Ng <keng.ng@newcastle.ac.uk">
<meta name="description" content="G-code generator for Otto, the fluid handling robot.">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
	font-family: sans-serif;
	font-size: 12pt;
	text-align: center;
}

input, select {
	font-family: sans-serif;
	font-size: 12pt;
}

input[type=button], input[type=reset] {
	padding: 5px 15px 5px 15px;
}

input[type=number] {
	width: 75px;
}

a.info {
	color: #FF3300;
	cursor: pointer;
	font-weight: bold;
}

h1 {
	color: #FF3300;
}

div.settings {
	text-align: left;
	width: 60%;
	margin: 10px;
	display: inline-block;
	vertical-align: top;
}

table {
	border-bottom: 2px solid #CCCCCC;
	border-top: 2px solid #CCCCCC;
	border-collapse: collapse;
	width: 100%;
}

table > thead > tr > th {
	padding: 5px;
	text-align: center;
}

table > tbody > tr > td {
	border-top: 1px solid #CCCCCC;
	padding: 5px;
}

div#sampleTable {
	border: 1px solid #CCCCCC;
	border-collapse: collapse;
	padding: 5px;
	height: 350px;
	overflow: auto;
}

div#sampleTable > table > tbody > tr > td {
	text-align: center;
}

div#gcode, div.gcode {
	border: 1px solid #CCCCCC;
	font-family: monospace;
	font-size: 11pt;
	height: 250px;
	overflow: auto;
	padding: 10px;
	text-align: left;
}

a#downloadLink {
	display: none;
}

input.number {
  text-align: right;
}
</style>

<script>
// Sample object
var Sample = function(interval, intervalUnits) {
	this.interval = interval;
	this.intervalUnits = intervalUnits;
}

// GCode object
function GCode() {
	// Set parameters
	var defaultInterval;
	var defaultIntervalUnits;
	var defaultIntervalMs;
	var refillZ;
	var refillStep;
	var dwellTime;
	var timestamp;  
	var refillSpeed;
	// Hard-coded parameters:
	var samples = [];
	var maxSamples = 20;
	var defaultBrakingZ = 58;
	var defaultSpeedZ = 500;
	var defaultSpeedXY = 3000;
	var defaultRefillZ;
	var needleSpeed = 500;
	var startX;	
	var startY;
	var tray2X;
	var stepX;
	var stepY;
	var zUp;
	var zDown;
	var skipRefill = false;
	var rightMost = 100; // 210;
	var ottomateUrl = document.location;
	var sourceRepoUrl = "https://github.com/ngkengwooi/ottomate";
	// Update user-defined defaults
	function getDefaults() {
		defaultInterval = Number(document.querySelector('#defaultInterval').value);
		defaultIntervalUnits = Number(document.querySelector('#defaultIntervalUnits').value);
		defaultIntervalMs = Number(defaultInterval * defaultIntervalUnits);
		defaultRefillZ = Number(document.querySelector('#refillZ').value); 
		refillZ = defaultRefillZ;
		refillStep = Number(document.querySelector('#refillStep').value);
		dwellTime = Number(document.querySelector('#dwellTime').value);
		dwellTimeUnits = Number(document.querySelector('#dwellTimeUnits').value);
		dwellTimeMs = Number(dwellTime * dwellTimeUnits);
		refillSpeed = Number(document.querySelector('#refillSpeed').value);
		startX = Number(document.querySelector('#startX').value);
		tray2X = Number(document.querySelector('#tray2X').value); 
		stepX = tray2X - startX;
		stepY = Number(document.querySelector('#stepY').value);
		startY = Number(document.querySelector('#startY').value) - stepY;
		zUp = Number(document.querySelector('#zUp').value);
		zDown = Number(document.querySelector('#zDown').value);
		skipRefill = (document.querySelector("#skipRefill").checked);
	};
	
	function loadProfiles() {
		document.querySelector('#profiles').options.length = 0;
		for (var i = 0; i < profiles.length; i++) {
			var option = document.createElement('option');
			option.text = profiles[i].buildId;
			document.querySelector('#profiles').add(option);
		}
	};
	// Function to add a sample to the sample list
	this.addSample = function() {
		if (samples.length < maxSamples) {
			samples.push(
				new Sample(
					document.querySelector('#defaultInterval').value,
					document.querySelector('#defaultIntervalUnits').value
				)
			);
			this.getCode();
		}
	};
	// Function to remove a sample from the sample list
	this.removeSample = function(index) {
		if (confirm('Remove sample at timepoint #' + eval(index + 1) + '?')) {
			samples.splice(index, 1);
			this.getCode();
		}
	};
	// Function to remove all samples from the sample list
	this.clearSamples = function() {
		if (confirm('This will remove all samples from the sample list!')) {
			samples = [];
			this.getCode();
		}
	};
	// Function to refresh the sample list
	function refreshSampleList() {
		var html;
		if (!samples.length) {
			html = '<table><thead><tr><th>' +
				'Start by adding a sample ' +
				'<a class="info" ' +
				'onclick="alert(\'Click the [Add sample] button below. ' +
				'The default sampling parameters specified under Run Settings will be applied automatically to any new sample, ' +
				'but you will be able to change them for each sample here.\');">&#9432;</a>' +
				'</th></tr></thead></table>';
		}
		else {
			html = '<table><thead><tr>' +
				'<th># <a class="info" ' +
				'onclick="alert(\'You may add up to ' + maxSamples + ' sampling timepoints. ' +
				'All samples are numbered automatically and sequentially by timepoint.\');">&#9432;</a></th>' +
				'<th>Interval <a class="info"' +
				'onclick="alert(\'Amount of time to wait before taking the sample.\');">&#9432;</a></th>' +
				'<th>Action</th>' +
				'</tr></thead><tbody>';
			for (var i = 0 ; i < samples.length; i++) {
				var sample = samples[i];
				html += '<tr>' +
					'<td>' + eval(i + 1) + '</td>' +
					'<td>' +
					'<input class="customInterval" class="number" type="number" id="interval' + i + '" min="1" value="' + sample.interval + 
					'" onchange="gcode.updateSample(' + i + ');"> ' +
					'<select class="customIntervalUnits" id="intervalUnits' + i + '" onchange="gcode.updateSample(' + i + ');">' +
					'<option value="1000"' + (sample.intervalUnits == 1000 ? ' selected' : '') + '>s</option>' +
					'<option value="60000"' + (sample.intervalUnits == 60000 ? ' selected' : '') + '>min</option>' +
					'<option value="3600000"' + (sample.intervalUnits == 3600000 ? ' selected' : '') + '>h</option>' +
					'</select>' +
				'</td>' +
				'<td><input type="button" value="Remove" onclick="gcode.removeSample(' + i + ');"></td>' +
				'</tr>';
			}
			html += '</tbody></table>';
		}
		document.querySelector('#sampleTable').innerHTML = html;
		document.querySelector('#addSampleButton').disabled = (samples.length < maxSamples ? false : true);
		document.querySelector('#clearSamplesButton').disabled = (!samples.length);
	};
	// Update a sample and automatically regenerate G-code
	this.updateSample = function(index) {
		samples[index].interval = Number(document.querySelector('#interval' + index).value);
		samples[index].intervalUnits = Number(document.querySelector('#intervalUnits' + index).value);
		this.getCode();
	};
	this.loadProfile = function(index) {
		var profile = profiles[index];
		for (var param in profile) {
			var value = profile[param];
			document.querySelector("#" + param).value = (isNaN(value) ? value : parseFloat(value).toFixed(1));
		}
	};
	// Function to generate G-code
	this.getCode = function() {
		timestamp = new Date();
		function autohome() {
			/*
			Every autohome motion is preceded by a needle up motion.
			This is to ensure the Z-axis is free to move without
			getting trapped in the vials or bumping the plungers.
			*/
			return moveZ(zUp, defaultSpeedZ, 'Needles up') 
				+ moveXY(0, 0, defaultSpeedXY, 'Zero X and Y axes simultaneously to save time')
				+ 'G28 ; Autohome\n';
		}		
		
		function moveZ(z, speed, comment) {
			speed = (!speed ? needleSpeed : speed);
			return 'G0 Z' + z + ' F' + speed + ((comment) ? ' ; ' + comment : '') + '\n';
		}
		
		function moveXY(x, y, speed, comment) {
			speed = (!speed ? defaultSpeedXY : speed);
			return 'G0 X' + x + ' Y' + y + ' F' + speed + ((comment) ? ' ; ' + comment : '') + '\n';
		}
		
		function needlesRight() {
			return moveZ(zUp, defaultSpeedZ, 'Needles up') + moveXY(rightMost, 0, defaultSpeedXY, 'Move needles to the right');
		}
		
		function takeSample(i, x, y) {			
			// Sampling routine
			var code = '; ------------------------------\n';
			code += '; Sample timepoint #' + eval(i + 1) + '\n';
			code += autohome(); // Always reset positions before sampling by autohoming
			code += moveZ(zUp, defaultSpeedZ, 'Raise needles'); // Move needles up
			code += moveXY(x, y, defaultSpeedXY, 'Align needles with vials'); // Align needles with vials
			code += moveZ(zDown, defaultSpeedZ, 'Lower needles'); // Insert needles into vials
			code += 'G4 P' + Number(dwellTimeMs) + ' ; Aspirate sample\n'; // Aspirate
			/*
			No explicit needle up motion required after sampling because
			the autohome routine will always perform a needle up motion.
			*/
			return code;
		}
		
		function refill(i) {
			var code = '';
			if (!skipRefill) {
				// Set refill positions
				brakingZ = Number(refillZ - 2);
				refillZ += refillStep;
				// Refilling routine
				code += '; ------------------------------\n';
				code += '; Refill timepoint #' + eval(i + 1) + '\n';
				code += autohome(); // Always reset position before refilling
				code += needlesRight();
				code += moveZ(brakingZ, defaultSpeedZ, 'Approach plungers'); // Move quickly to just below plungers
				code += moveZ(
					Number(refillZ), 
					Number(refillSpeed),
					'Push plungers'
				); // Move slowly to push plungers
				/*
				Leave the Z-axis where it is during the post-sample interval
				to indicate the experiment is still in progress.
				This will also allow any Z-slipping to be detected.
				*/
			}
			return code;
		}
		
		function calibrateZ() {
			var code = 
		  '; ------------------------------\n' +
		  'G90 ; Use absolute coordinates\n' +
		  'G28 ; Autohome\n' +
		  needlesRight() +
		  moveZ(defaultBrakingZ, defaultSpeedZ, 'Approach syringes') +
		  moveZ(Number(defaultRefillZ),
		    Number(refillSpeed),
		    'Push plungers'); // Move slowly to push plungers
			return code;
		}
		
		
		loadProfiles();
		// Get user-defined defaults
		getDefaults();
		// Reset hard-coded parameters
		var tray = 1;
		var x = startX;
		var y = startY;
		var brakingZ = defaultBrakingZ;
		// Refresh sample list
		refreshSampleList();
		
		
		// G-code preamble
		var code = '; G-code for sampling and refilling.\n';
		code += '; Created: ' + timestamp + '\n' +
		  '; Do not edit this file manually.\n' +
		  '; Use the G-code generator instead:\n' +
		  '; ' + ottomateUrl + '\n' +
		  '; Source: ' + sourceRepoUrl + '\n' +
		  '; ------------------------------\n' +
		  'G90 ; Use absolute coordinates\n' +
		  'G28 ; Autohome\n';
		for (var i = 0; i < samples.length; i++) {
			// Set XYZ positions
			if (i == 10) {
				tray = 2;
				x = tray2X;
				y = startY;
			}
			y += stepY;
			// Wait for interval
			intervalMs = (samples[i].interval * samples[i].intervalUnits);
			code += '; ------------------------------\n';
			code += '; Interval\n';
			code += 'G4 P' + Number(intervalMs) + '\n';
			code += takeSample(i, x, y);
			code += refill(i);
		}
		code += '; ------------------------------\n';
		code += '; All done\n';
		code += autohome();
		document.querySelector('#gcode').innerText = code;
		document.querySelector('#primingCode').innerText = '; G-code for priming the refill line.\n' +
		  '; Created: ' + timestamp + '\n' +
		  '; Do not edit this file manually.\n' +
		  '; Use the G-code generator instead:\n' +
		  '; ' + ottomateUrl + '\n' +
		  '; Source: ' + sourceRepoUrl + '\n' +
		  calibrateZ() + 
		  autohome();
	};
	
	// Function to copy G-code to system clipboard
	async function copyToClipboard(content) {
		try {
			await navigator.clipboard.writeText(document.querySelector(content).innerText);
			alert('G-code copied to clipboard.')
		} catch (error) {
			alert('Failed to copy to clipboard.');
		}
	};
	this.copy = copyToClipboard;
	
	this.download = function(element, content) {
		var title = prompt('G-code description:');		
		title = (!title) ? 'Otto' : title;
		fileName = title + '.gcode' 
		document.querySelector(element).href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(document.querySelector(content).innerText);
		document.querySelector(element).download = fileName;
		document.querySelector(element).click();
	};
	
}

var profiles = [
	{
		'buildId': '0884',
		'startX': 14.5,
		'tray2X': 119.2,
		'startY': 63.0,
		'stepY': 18.9,
		'zUp': 27.0,
		'zDown': 6.0
	},
	{
		'buildId': '4002',
		'startX': 14.5,
		'tray2X': 119.0,
		'startY': 63.0,
		'stepY': 19.0,
		'zUp': 27.0,
		'zDown': 6.0
	}
];

function init() {
	// Initialise G-code generator
	gcode = new GCode();
	gcode.getCode();
};

window.onload = init;

</script>
</head>
<body>


<div class="settings">
<h1>Calibration</h1>
<table>
	<tbody>
	<tr>
		<td style="width: 200px;">
			<label for="profile">Load preset profile:</label> <a class="info"onclick="alert('Load the hardcorded calibration parameters for a specific build. The profile ID corresponds to the last 4 digits of the gantry\'s serial number.\n\nIrrespective of the loaded profile, you can modify each calibration parameter as needed. The preset profiles are read-only and will not be overwritten.');">&#9432;</a>
		</td>
		<td>
			<select id="profiles" onchange="gcode.loadProfile(this.selectedIndex);"></select>
			<input type="hidden" id="buildId">
		</td>
	</tr>
	<tr>
		<td>
			<label for="startX">Tray 1 X-position:</label> <a class="info"onclick="alert('Calibrated X position for sampling point 1.');">&#9432;</a>
		</td>
		<td>
			<input id="startX" class="number" type="number" value="14.5" placeholder="0.0" min="1" max="20" step=".1" onchange="gcode.getCode();"> mm
		</td>
	</tr>
	<tr>
		<td>
			<label for="tray2X">Tray 2 X-position:</label> <a class="info"onclick="alert('Calibrated tray 2 X-position.');">&#9432;</a>
		</td>
		<td>
			<input id="tray2X" class="number" type="number" value="119.2" placeholder="0.0" step=".1" min="1" max="150" onchange="gcode.getCode();"> mm
		</td>
	</tr>
	<tr>
		<td>
			<label for="startY">Starting Y-position:</label> <a class="info"onclick="alert('Calibrated X position for sampling point 1.');">&#9432;</a>
		</td>
		<td>
			<input id="startY" class="number" type="number" value="63.0" placeholder="0.0" step=".1" min="1" max="70" onchange="gcode.getCode();"> mm
		</td>
	</tr>
	<tr>
		<td>
			<label for="stepY">Y increment:</label> <a class="info"onclick="alert('Increment in Y-position from one sample to the next.');">&#9432;</a>
		</td>
		<td>
			<input id="stepY" class="number" type="number" value="18.9" placeholder="0.0" step=".1" min="1" max="25" onchange="gcode.getCode();"> mm
		</td>
	</tr>
	<tr>
		<td>
			<label for="zUp">Needle up position:</label> <a class="info"onclick="alert('Z-position when needles are above sample vials.');">&#9432;</a>
		</td>
		<td>
			<input id="zUp" class="number" type="number" value="27.0" placeholder="0.0" step=".1" min="1" max="35" onchange="gcode.getCode();"> mm
		</td>
	</tr>
	<tr>
		<td>
			<label for="zDown">Needle down position:</label> <a class="info"onclick="alert('Z-position when needles are in sample vials.');">&#9432;</a>
		</td>
		<td>
			<input id="zDown" class="number" type="number" value="6.0" placeholder="0.0" step=".1" min="1" max="15" onchange="gcode.getCode();"> mm
		</td>
	</tr>
	</tbody>
</table>
</div>

<div class="settings">

<h1>Run Settings</h1>
<form>
<table>
	<tbody>
	<tr>
		<td style="width: 200px;">
			<label for="defaultInterval">Default interval:</label> <a class="info"onclick="alert('The amount of time to wait before/after taking a sample. This will be applied to any new sample you add, but you will be able to change it per sample later.');">&#9432;</a>
		</td>
		<td>
			<input id="defaultInterval" class="number" type="number" value="1" min="1" onchange="gcode.getCode();">
			<select id="defaultIntervalUnits" onchange="gcode.getCode();">
				<option value="1000">s</option>
				<option value="60000">min</option>
				<option value="3600000" selected>h</option>
			</select>
		</td>
	</tr>
	<tr>
		<td>
			<label for="dwellTime">Sampling duration:</label> <a class="info"onclick="alert('The sample will be aspirated for this amount of time. This applies to all samples in the run. You cannot change it per sample.');">&#9432;</a>
		</td>
		<td>
			<input id="dwellTime" class="number" type="number" value="30" min="1" onchange="gcode.getCode();">
			<select id="dwellTimeUnits" onchange="gcode.getCode();">
				<option value="1000" selected>s</option>
				<option value="60000">min</option>
				<!-- <option value="3600000">hours</option> -->
			</select>
		</td>
	</tr>
	<tr>
		<td>
			<label for="refillZ">Refill baseline:</label> <a class="info"onclick="alert('Plunger position before the first refill. This applies to the entire run. You cannot change it per sample.');">&#9432;</a>
		</td>
		<td>
			<input id="refillZ" class="number" type="number" value="60" min="60" onchange="gcode.getCode();"> mm
		</td>
	</tr>
	<tr>
		<td>
			<label for="refillStep">Refill step size:</label> <a class="info"onclick="alert('This determines the refill volume. It applies to the entire run. You cannot change it per sample.');">&#9432;</a>
		</td>
		<td>
			<input id="refillStep" class="number" type="number" value="2" min="0" onchange="gcode.getCode();"> mm
		</td>
	</tr>		
	<tr>
		<td>
			<label for="refillSpeed">Refill speed:</label> <a class="info"onclick="alert('A high refill speed may cause excessive resistance with narrow-gauge refill needles. This applies to the entire run. You cannot change it per sample.');">&#9432;</a>
		</td>
		<td>
			<input id="refillSpeed" class="number" type="number" value="50" min="1" max="500" onchange="gcode.getCode();"> mm/min
		</td>
	</tr>
	</tbody>
</table>
<p><input type="reset" value="Use default" onclick="return (confirm('Reset all parameters to their default values?'));"></p>
</form>
</div>

<div class="settings">

<h1>Sample Settings</h1>

<div id="sampleTable"></div>

<div>
	<p>
	<input id="addSampleButton" type="button" value="Add sample" onclick="gcode.addSample();">
	<input id="clearSamplesButton" type="button" value="Clear all samples" onclick="gcode.clearSamples();">
	</p>
</div>

</div>


<div class="settings">
	<h1>Prime G-code</h1>
	  <div id="primingCode" class="gcode"></div>
	  <div>
	    <a id="downloadPrimingGCode"></a>
	    <p>
	    <input id="copyPrimingCodeButton" type="button" value="Copy" onclick="gcode.copy('#primingCode');">
	    <input id="downloadPrimeCodeButton" type="button" value="Download" onclick="gcode.download('#downloadPrimingGCode', '#primingCode');"></p>
	  </div>
	</div>
</div>

<div class="settings">
	<h1>Run G-code</h1>
	<div id="gcode"></div>
	<div>
	<a id="downloadLink"></a>
	<p><input type="checkbox" id="skipRefill" onchange="gcode.getCode();"> <label for="skipRefill">Skip refill</label> <a class="info"onclick="alert('Perform only the sampling motion. If this option is enabled, Otto will not perform the refilling motion.\n\nIntended for use with a simulated run only (e.g., to verify needle-vial alignment). You most likely do not want to enable this for an actual experiment.');">&#9432;</a></p>
	<p>
	<input id="copyGCodeButton" type="button" value="Copy" onclick="gcode.copy('#gcode');">
	<input id="downloadButton" type="button" value="Download" onclick="gcode.download('#downloadLink', '#gcode');">
	</p>
	</div>
</div>
</body>
</html>
